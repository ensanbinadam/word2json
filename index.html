<!DOCTYPE html>
<html dir="rtl" lang="ar">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
      أداة تحويل الكويز المتقدمة - نسخة تلقائية إزالة الخلفية (جودة أعلى)
    </title>

    <!-- مكتبات خارجية -->
    <!-- Mammoth.js (تحويل DOCX إلى HTML) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.10.0/mammoth.browser.min.js"></script>

    <!-- DOMPurify (تنقية HTML ومنع XSS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.6/purify.min.js"></script>

    <!-- Font Awesome (all.min.css للأيقونات) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />

    <style>
      :root {
        --primary-color: #1a73e8;
        --primary-hover: #1557b0;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --danger-hover: #b02a37;
        --background-color: #f8f9fa;
        --card-background: #fff;
        --border-color: #e9ecef;
        --text-color: #343a40;
        --text-muted: #6c757d;
        --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        --border-radius: 8px;
        --warning-color: #ff9800;
        --gold-color: #ffd700;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #f5f7fa, #e4edf9);
        padding: 20px;
        color: var(--text-color);
        line-height: 1.6;
        min-height: 100vh;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      header {
        text-align: center;
        padding: 20px 0;
        background: linear-gradient(135deg, var(--primary-color), #4285f4);
        border-radius: var(--border-radius);
        margin-bottom: 30px;
        color: #fff;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
      }
      header::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.1) 0%,
          rgba(255, 255, 255, 0) 70%
        );
      }
      h1 {
        font-size: 2.8rem;
        margin-bottom: 10px;
        position: relative;
        z-index: 2;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      .subtitle {
        font-size: 1.3rem;
        opacity: 0.9;
        position: relative;
        z-index: 2;
      }
      .section {
        background: var(--card-background);
        padding: 25px;
        border-radius: var(--border-radius);
        margin-bottom: 25px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      .section:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      }
      .section h2 {
        color: var(--primary-color);
        margin: 0 0 20px;
        font-size: 1.6rem;
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .btn {
        background: var(--primary-color);
        color: #fff;
        padding: 14px 24px;
        border: none;
        border-radius: var(--border-radius);
        margin: 8px 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 10px rgba(26, 115, 232, 0.3);
      }
      .btn:hover {
        background: var(--primary-hover);
        transform: translateY(-3px);
        box-shadow: 0 6px 18px rgba(26, 115, 232, 0.4);
      }
      .btn.success {
        background: var(--success-color);
      }
      .btn.danger {
        background: var(--danger-color);
      }
      .btn.warning {
        background: var(--warning-color);
      }
      .btn.gold {
        background: var(--gold-color);
        color: #333;
      }
      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .file-upload-container {
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
        border: 2px dashed var(--primary-color);
        border-radius: var(--border-radius);
        padding: 25px;
        background: rgba(26, 115, 232, 0.05);
      }
      .file-input-container {
        position: relative;
        display: inline-block;
        width: 100%;
        margin-bottom: 15px;
      }
      .file-input {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }
      .file-input-label {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        background: var(--primary-color);
        color: #fff;
        padding: 18px 30px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 18px;
        font-weight: 600;
        text-align: center;
        border: 2px solid rgba(255, 255, 255, 0.2);
      }
      .upload-icon {
        display: flex;
        justify-content: center;
        margin-bottom: 10px;
        font-size: 72px;
        color: var(--primary-color);
        opacity: 0.8;
      }
      .upload-text {
        text-align: center;
        color: var(--text-muted);
        margin-bottom: 20px;
      }
      .file-types {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 10px;
      }
      .file-type {
        background: rgba(26, 115, 232, 0.1);
        color: var(--primary-color);
        padding: 8px 18px;
        border-radius: 20px;
        font-size: 16px;
        font-weight: 500;
      }
      input[type="number"] {
        padding: 10px 14px;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: 16px;
        width: 90px;
        font-weight: bold;
        text-align: center;
      }
      input[type="number"]:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
      }
      .config-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        background: #fff;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow);
      }
      .config-table th,
      .config-table td {
        padding: 14px;
        text-align: center;
        border: 1px solid var(--border-color);
      }
      .config-table th {
        background: linear-gradient(135deg, var(--primary-color), #4285f4);
        color: #fff;
        font-weight: 600;
        font-size: 16px;
      }
      .note {
        background: #e3f2fd;
        border-left: 4px solid var(--primary-color);
        padding: 18px;
        margin: 20px 0;
        border-radius: var(--border-radius);
        color: var(--text-muted);
        font-size: 16px;
      }
      .file-info-box {
        background: #e8f5e9;
        border-left: 4px solid var(--success-color);
        padding: 18px;
        margin: 20px 0;
        border-radius: var(--border-radius);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .file-info-row {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .file-info-label {
        font-weight: bold;
        min-width: 140px;
        font-size: 16px;
      }
      .file-info-value {
        flex: 1;
        word-break: break-all;
        font-weight: 500;
      }
      .progress-bar {
        width: 100%;
        height: 8px;
        background: var(--border-color);
        border-radius: 4px;
        overflow: hidden;
        margin: 15px 0;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color), #4285f4);
        transition: width 0.5s ease;
      }
      .question-card {
        background: #fff;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: var(--shadow);
        position: relative;
        transition: all 0.3s ease;
      }
      .question-card:hover {
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
      }
      .options-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      .option-box {
        border: 2px dashed var(--border-color);
        padding: 18px;
        border-radius: var(--border-radius);
        background: #f8f9fa;
        transition: all 0.3s ease;
        position: relative;
      }
      .option-box:hover {
        border-color: var(--primary-color);
        background: #e3f2fd;
        transform: translateY(-3px);
      }
      .option-box.correct {
        border: 2px solid var(--success-color);
        background: #e6f4ea;
        box-shadow: 0 4px 10px rgba(40, 167, 69, 0.2);
      }
      .option-box label {
        font-weight: 600;
        color: var(--text-color);
        display: block;
        margin-bottom: 12px;
        font-size: 17px;
      }
      .image-preview {
        display: block;
        max-width: 100%;
        max-height: 150px;
        object-fit: contain;
        margin: 15px auto;
        border-radius: 8px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #eee;
        background: transparent;
      }
      .loading {
        display: none;
        text-align: center;
        padding: 25px;
        color: var(--text-muted);
      }
      .spinner {
        border: 4px solid var(--border-color);
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .stats-bar {
        display: flex;
        justify-content: space-around;
        background: #fff;
        padding: 20px;
        border-radius: var(--border-radius);
        margin-bottom: 25px;
        box-shadow: var(--shadow);
      }
      .stat-item {
        text-align: center;
        padding: 15px;
        border-radius: var(--border-radius);
        background: #f8f9fa;
        width: 30%;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
      }
      .stat-number {
        font-size: 2.2rem;
        font-weight: bold;
        color: var(--primary-color);
        margin: 10px 0;
      }
      .stat-label {
        color: var(--text-muted);
        font-size: 1rem;
        font-weight: 600;
      }
      .alert {
        padding: 18px;
        border-radius: var(--border-radius);
        margin: 15px 0;
        position: fixed;
        top: 25px;
        right: 25px;
        z-index: 1000;
        max-width: 450px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 16px;
        font-weight: 500;
        opacity: 0.98;
      }
      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .alert-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      .json-section {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        border-left: 4px solid #1a73e8;
      }
      .processing-bar {
        width: 100%;
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
        margin: 15px 0;
      }
      .processing-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #8bc34a);
        transition: width 0.5s ease;
      }
      .image-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        flex-wrap: wrap;
      }
      .feature-badge {
        position: absolute;
        top: 15px;
        left: 15px;
        background: var(--gold-color);
        color: #333;
        padding: 8px 15px;
        border-radius: 30px;
        font-weight: bold;
        font-size: 14px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        z-index: 10;
      }
      .preset-manager {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
      }
      .preset-manager h4 {
        margin-bottom: 12px;
        color: var(--primary-color);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .preset-controls {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .preset-controls select {
        flex-grow: 1;
        padding: 10px;
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
      }
      @media (max-width: 768px) {
        .options-grid {
          grid-template-columns: 1fr;
        }
      }
        .footer {
        font-family: "Cairo", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: var(--text);
        text-align: center;
        padding: 14px 12px;
        border-top: 1px solid #e5e7eb;
        background: transparent;
        line-height: 1.7;
        font-size: 0.95rem;
      }
      .footer .line {
        margin: 2px 0;
      }
      .footer a {
        color: var(--primary);
        text-decoration: none;
        font-weight: 700;
      }
      .footer a:hover {
        text-decoration: underline;
      }
      .footer .sep {
        margin: 0 6px;
        color: var(--muted);
      }
      @media print {
        .footer {
          page-break-inside: avoid;
          font-size: 0.9rem;
        }
        .footer a {
          color: #1f3af5 !important;
          text-decoration: none;
        }
      }
    </style>

    <style id="ambiguous-style-patch">
      .option-box.ambiguous {
        border: 2px dashed #dc3545;
        background: rgba(220, 53, 69, 0.08);
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.12) inset;
      }
      .ambiguous-note {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffe08a;
        padding: 10px 12px;
        border-radius: 8px;
        margin: 12px 0;
        font-weight: 600;
        text-align: right;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="feature-badge">نسخة تلقائية (حواف أنعم)</div>
        <h1>📝 أداة تحويل الكويز المتقدمة</h1>
        <p class="subtitle">
          🚀 تحويل جداول Word إلى JSON — إزالة الخلفية وتنقية الحواف تلقائيًا
        </p>
      </header>

      <div class="section">
        <h2>📄 رفع ملف Word</h2>
        <div class="file-upload-container" id="dropZone">
          <div class="upload-icon">☁️</div>
          <div class="upload-text">
            <h3>اسحب وأفلت ملفاتك هنا</h3>
            <p>أو اختر ملف من جهازك</p>
          </div>
          <div class="file-input-container">
            <input
              type="file"
              id="docxFile"
              accept=".docx"
              class="file-input"
              multiple
            />
            <label for="docxFile" class="file-input-label"
              >📄 اختر ملف Word</label
            >
          </div>
          <div class="file-types"><span class="file-type">DOCX</span></div>
        </div>
        <div id="fileInfo" class="file-info-box" style="display: none">
          <div class="file-info-row">
            <span class="file-info-label">اسم الملف:</span
            ><span class="file-info-value" id="fileName">-</span>
          </div>
          <div class="file-info-row">
            <span class="file-info-label">حجم الملف:</span
            ><span class="file-info-value" id="fileSize">-</span>
          </div>
          <div class="file-info-row">
            <span class="file-info-label">تاريخ التحميل:</span
            ><span class="file-info-value" id="uploadDate">-</span>
          </div>
        </div>
      </div>

      <div class="section json-section">
        <h2>🗂️ فتح ملفات JSON القديمة</h2>
        <div class="file-upload-container">
          <div class="upload-icon">🗃️</div>
          <div class="upload-text">
            <h3>افتح ملفات JSON المحفوظة مسبقًا</h3>
            <p>قم بمعاينة الأسئلة وتعديلها وإعادة تصديرها</p>
          </div>
          <div class="file-input-container">
            <input
              type="file"
              id="jsonFile"
              accept=".json"
              class="file-input"
            />
            <label for="jsonFile" class="file-input-label"
              >📦 اختر ملف JSON</label
            >
          </div>
        </div>
        <div
          style="
            text-align: center;
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            gap: 20px;
            font-weight: 600;
          "
        >
          <label style="cursor: pointer"
            ><input
              type="radio"
              name="jsonImportMode"
              value="replace"
              checked
            />
            🔄 استبدال القائمة الحالية</label
          >
          <label style="cursor: pointer"
            ><input type="radio" name="jsonImportMode" value="merge" /> ➕ دمج
            مع القائمة الحالية</label
          >
        </div>
        <div class="loading" id="jsonLoading" style="display: none">
          <div class="spinner"></div>
          <p>جاري تحميل ومعالجة ملف JSON...</p>
          <div class="processing-bar">
            <div
              class="processing-fill"
              id="jsonProgress"
              style="width: 0%"
            ></div>
          </div>
        </div>
      </div>

      <div class="section">
        <h2>⚙️ إعدادات الجدول</h2>
        <div
          class="config-input"
          style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap"
        >
          <label>عدد الصفوف لكل سؤال:</label>
          <input
            type="number"
            id="rowsPerQuestion"
            value="5"
            min="1"
            max="20"
          />

          <label>عدد صفوف البحث أسفل الخيارات:</label>
          <input
            type="number"
            id="lookaheadRows"
            value="3"
            min="0"
            max="10"
            title="0 يعني تعطيل البحث أسفل الخيارات"
          />

          <!-- إعدادات إزالة الخلفية -->
          <div
            class="config-input"
            style="
              margin-top: 16px;
              display: flex;
              gap: 16px;
              align-items: center;
              flex-wrap: wrap;
            "
          >
            <label
              ><input type="checkbox" id="enableBg" /> تفعيل إزالة
              الخلفية</label
            >

            <label>النمط:</label>
            <select id="bgPreset">
              <option value="safe">محافظة (موصى بها)</option>
              <option value="balanced" selected>متوازنة</option>
              <option value="strong">قوية</option>
            </select>

            <details id="bgAdvanced" style="margin-inline-start: auto">
              <summary>خيارات متقدمة</summary>
              <div
                style="
                  display: flex;
                  gap: 10px;
                  margin-top: 10px;
                  flex-wrap: wrap;
                "
              >
                <label
                  >الحد الداخلي:
                  <input
                    type="number"
                    id="bgInner"
                    min="0"
                    max="80"
                    value="18"
                    style="width: 80px"
                /></label>
                <label
                  >الحد الخارجي:
                  <input
                    type="number"
                    id="bgOuter"
                    min="1"
                    max="100"
                    value="38"
                    style="width: 80px"
                /></label>
                <label
                  >Supersampling:
                  <input
                    type="number"
                    id="bgSS"
                    min="1"
                    max="3"
                    value="2"
                    style="width: 80px"
                /></label>
                <label
                  >تمليس (px):
                  <input
                    type="number"
                    id="bgBlurR"
                    min="0"
                    max="3"
                    value="1"
                    style="width: 80px"
                /></label>
                <label
                  >تمريرات:
                  <input
                    type="number"
                    id="bgBlurP"
                    min="0"
                    max="3"
                    value="2"
                    style="width: 80px"
                /></label>
              </div>
            </details>
          </div>
        </div>

        <div class="coords-grid">
          <h3>📍 إحداثيات النص القرائي والسؤال</h3>
          <table class="config-table">
            <thead>
              <tr>
                <th>📘 نص قرائي</th>
                <th>🖼️ صورة النص</th>
                <th>❓ سؤال</th>
                <th>🖼️ صورة السؤال</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <input type="number" name="r_reading" value="1" min="1" />
                  <input type="number" name="c_reading" value="1" min="1" />
                </td>
                <td>
                  <input type="number" name="r_reading_img" value="1" min="1" />
                  <input type="number" name="c_reading_img" value="2" min="1" />
                </td>
                <td>
                  <input type="number" name="r_question" value="2" min="1" />
                  <input type="number" name="c_question" value="1" min="1" />
                </td>
                <td>
                  <input
                    type="number"
                    name="r_question_img"
                    value="2"
                    min="1"
                  />
                  <input
                    type="number"
                    name="c_question_img"
                    value="2"
                    min="1"
                  />
                </td>
              </tr>
            </tbody>
          </table>

          <h3>🧭 إحداثيات نص الخيارات</h3>
          <table class="config-table">
            <thead>
              <tr>
                <th>①</th>
                <th>②</th>
                <th>③</th>
                <th>④</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <input type="number" name="r_opt1" value="3" min="1" />
                  <input type="number" name="c_opt1" value="1" min="1" />
                </td>
                <td>
                  <input type="number" name="r_opt2" value="3" min="1" />
                  <input type="number" name="c_opt2" value="2" min="1" />
                </td>
                <td>
                  <input type="number" name="r_opt3" value="4" min="1" />
                  <input type="number" name="c_opt3" value="1" min="1" />
                </td>
                <td>
                  <input type="number" name="r_opt4" value="4" min="1" />
                  <input type="number" name="c_opt4" value="2" min="1" />
                </td>
              </tr>
            </tbody>
          </table>

          <h3>🖼️ إحداثيات صور الخيارات</h3>
          <table class="config-table">
            <thead>
              <tr>
                <th>①</th>
                <th>②</th>
                <th>③</th>
                <th>④</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <input type="number" name="r_opt1_img" value="3" min="1" />
                  <input type="number" name="c_opt1_img" value="3" min="1" />
                </td>
                <td>
                  <input type="number" name="r_opt2_img" value="3" min="1" />
                  <input type="number" name="c_opt2_img" value="4" min="1" />
                </td>
                <td>
                  <input type="number" name="r_opt3_img" value="4" min="1" />
                  <input type="number" name="c_opt3_img" value="3" min="1" />
                </td>
                <td>
                  <input type="number" name="r_opt4_img" value="4" min="1" />
                  <input type="number" name="c_opt4_img" value="4" min="1" />
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="preset-manager">
          <h4><i class="fas fa-save"></i> الإعدادات المسبقة للإحداثيات</h4>
          <div class="preset-controls">
            <select id="coordPresets"></select>
            <button class="btn" onclick="saveCoordinatesPreset()">
              💾 حفظ الحالي
            </button>
            <button class="btn danger" onclick="deleteCoordinatesPreset()">
              🗑️ حذف المحدد
            </button>
          </div>
        </div>

        <div style="text-align: center; margin-top: 25px">
          <button class="btn danger" onclick="clearAll()">
            🗑️ مسح جميع الأسئلة
          </button>
          <button class="btn" onclick="resetCoordinates()">
            🔄 إعادة تعيين الإحداثيات
          </button>
        </div>
      </div>

      <div class="section">
        <h2>🔍 تحليل الجدول</h2>
        <button class="btn" id="processButton" onclick="processFile()">
          ▶️ بدء التحليل
        </button>
        <div class="loading" id="loadingIndicator">
          <div class="spinner"></div>
          <p>جاري تحليل الملف...</p>
        </div>
        <div class="progress-bar" id="progressBar" style="display: none">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>

      <div class="stats-bar" id="statsBar" style="display: none">
        <div class="stat-item">
          <div class="stat-number" id="totalQuestions">0</div>
          <div class="stat-label">إجمالي الأسئلة</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="answeredQuestions">0</div>
          <div class="stat-label">أسئلة مجابة</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="questionsWithImages">0</div>
          <div class="stat-label">أسئلة بصور</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="ambiguousQuestions">0</div>
          <div class="stat-label">أجابات متضاربة النجوم</div>
        </div>
      </div>

      <div class="section">
        <h2>👁️ معاينة الأسئلة</h2>
        <div id="outputArea"></div>
      </div>

      <div style="text-align: center; margin-bottom: 40px">
        <button class="btn success" onclick="exportJSON()">
          📤 تصدير JSON
        </button>
        <button class="btn" onclick="exportCSV()">📄 تصدير CSV</button>
        <button class="btn" onclick="previewJSON()">🧾 معاينة JSON</button>
      </div>
   <footer class="footer" dir="rtl">
      <div class="line">
        <span>برمجة:أ/عبدالعزيز العبدالجبار</span>
        <span class="sep">•</span>
        <span>باستخدام</span>
        <a
          href="https://gemini.google.com"
          target="_blank"
          rel="noopener noreferrer"
          >gemini</a
        >
        <a
         href="https://chatgpt.com"
         target="_blank" 
         rel="noopener noreferrer"
          >ChatGPT</a
        >
      </div>
      <div class="line">جميع الحقوق محفوظة لملتقى معلمي ومعلمات الرياضيات</div>
      <div class="line">
        <span>للاستفسار والتواصل: </span>
        <a href="https://t.me/ITG_KSA" target="_blank" rel="noopener noreferrer"
          >ملتقى التعليم التفاعلي</a
        >
      </div>
    </footer>

        >
      </div>
    </footer>

    <script>
      // IIFE to encapsulate the entire script
      (function () {
        /* ========= الحالة العامة ========= */
        let currentFiles = [];
        const questions = [];

        /* ========= أدوات الواجهة ========= */
        function showAlert(message, type) {
          document.querySelectorAll(".alert").forEach((a) => a.remove());
          const div = document.createElement("div");
          div.className = `alert alert-${type}`;
          div.textContent = message;
          document.body.appendChild(div);
          setTimeout(() => div.remove(), 5000);
        }
        function isRowEmpty(row) {
          const cells = row.querySelectorAll("td,th");
          return Array.from(cells).every((td) => {
            const t = (td.textContent || "")
              .replace(/[\u200f\u200e]/g, "")
              .trim();
            const img = td.querySelector("img");
            return !t && !img;
          });
        }
        function getCoordinates() {
          return {
            readingText: [+v("r_reading"), +v("c_reading")],
            readingImage: [+v("r_reading_img"), +v("c_reading_img")],
            questionText: [+v("r_question"), +v("c_question")],
            questionImage: [+v("r_question_img"), +v("c_question_img")],
            options: [
              {
                text: [+v("r_opt1"), +v("c_opt1")],
                image: [+v("r_opt1_img"), +v("c_opt1_img")],
              },
              {
                text: [+v("r_opt2"), +v("c_opt2")],
                image: [+v("r_opt2_img"), +v("c_opt2_img")],
              },
              {
                text: [+v("r_opt3"), +v("c_opt3")],
                image: [+v("r_opt3_img"), +v("c_opt3_img")],
              },
              {
                text: [+v("r_opt4"), +v("c_opt4")],
                image: [+v("r_opt4_img"), +v("c_opt4_img")],
              },
            ],
          };
        }
        function v(name) {
          return document.querySelector(`input[name="${name}"]`).value || 1;
        }
        function cell(rows, [r, c]) {
          const rr = r - 1;
          if (rr < 0 || rr >= rows.length) return { text: "", image: null };
          const tds = rows[rr].querySelectorAll("td,th");
          if (c < 1 || c > tds.length) return { text: "", image: null };
          const td = tds[c - 1];
          return {
            text: (td.textContent || "")
              .replace(/[\u200f\u200e]/g, "")
              .replace(/\s+/g, " ")
              .trim(),
            image: td.querySelector("img") ? td.querySelector("img").src : null,
          };
        }

        /* ========= إعدادات الإحداثيات المسبقة ========= */
        const COORD_PRESET_PREFIX = "coord_preset_";
        const coordPresetSelect = document.getElementById("coordPresets");

        function getCoordinateInputs() {
          return document.querySelectorAll('.coords-grid input[type="number"]');
        }

        function saveCoordinatesPreset() {
          const name = prompt("أدخل اسمًا للإعداد المسبق:", "قالب الاختبار 1");
          if (!name || !name.trim()) {
            showAlert("تم الإلغاء. يجب إدخال اسم.", "warning");
            return;
          }
          const presetName = name.trim();
          const coords = {};
          getCoordinateInputs().forEach((input) => {
            coords[input.name] = input.value;
          });
          localStorage.setItem(
            COORD_PRESET_PREFIX + presetName,
            JSON.stringify(coords)
          );
          populatePresetsDropdown();
          coordPresetSelect.value = presetName;
          showAlert(`✅ تم حفظ الإعداد المسبق "${presetName}"`, "success");
        }

        function loadCoordinatesPreset() {
          const presetName = coordPresetSelect.value;
          if (!presetName) return;
          const data = localStorage.getItem(COORD_PRESET_PREFIX + presetName);
          if (!data) {
            showAlert("لم يتم العثور على الإعداد المسبق.", "error");
            return;
          }
          try {
            const coords = JSON.parse(data);
            getCoordinateInputs().forEach((input) => {
              if (coords[input.name] !== undefined) {
                input.value = coords[input.name];
              }
            });
            showAlert(`👍 تم تحميل الإعداد المسبق "${presetName}"`, "success");
          } catch (e) {
            showAlert("خطأ في تحميل الإعداد المسبق.", "error");
          }
        }

        function deleteCoordinatesPreset() {
          const presetName = coordPresetSelect.value;
          if (!presetName) {
            showAlert("الرجاء تحديد إعداد مسبق لحذفه.", "warning");
            return;
          }
          if (confirm(`هل أنت متأكد من حذف الإعداد المسبق "${presetName}"؟`)) {
            localStorage.removeItem(COORD_PRESET_PREFIX + presetName);
            populatePresetsDropdown();
            showAlert(`🗑️ تم حذف الإعداد المسبق "${presetName}"`, "success");
          }
        }

        function populatePresetsDropdown() {
          const presets = [];
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(COORD_PRESET_PREFIX)) {
              presets.push(key.substring(COORD_PRESET_PREFIX.length));
            }
          }
          coordPresetSelect.innerHTML =
            '<option value="">-- اختر إعدادًا مسبقًا --</option>';
          presets.sort().forEach((name) => {
            const option = document.createElement("option");
            option.value = name;
            option.textContent = name;
            coordPresetSelect.appendChild(option);
          });
        }

        /* ========= إزالة الخلفية – تلقائية محسّنة الجودة ========= */
        const BG_PRESETS = {
          safe: { inner: 10, outer: 22, ss: 1, blurR: 1, blurP: 1 },
          balanced: { inner: 18, outer: 38, ss: 2, blurR: 1, blurP: 2 },
          strong: { inner: 30, outer: 60, ss: 3, blurR: 1, blurP: 3 },
        };

        function bgIsEnabled() {
          const el = document.getElementById("enableBg");
          return !!el && el.checked;
        }
        function readBgPreset() {
          const sel = document.getElementById("bgPreset");
          return sel ? sel.value || "balanced" : "balanced";
        }
        function readBgAdvanced() {
          const g = (id, def) => {
            const el = document.getElementById(id);
            const v = parseInt(el?.value, 10);
            return Number.isFinite(v) ? v : def;
          };
          const inner = g("bgInner", 18);
          const outer = Math.max(inner + 1, g("bgOuter", 38));
          return {
            inner,
            outer,
            ss: Math.max(1, Math.min(3, g("bgSS", 2))),
            blurR: Math.max(0, Math.min(3, g("bgBlurR", 1))),
            blurP: Math.max(0, Math.min(3, g("bgBlurP", 2))),
          };
        }
        function getBgParams() {
          const preset = BG_PRESETS[readBgPreset()] || BG_PRESETS.balanced;
          const adv = readBgAdvanced();
          // نستخدم قيم المتقدمة (إن تغيّرت)، وإلا ن fallback للpreset
          return {
            inner: adv.inner ?? preset.inner,
            outer: adv.outer ?? preset.outer,
            ss: adv.ss ?? preset.ss,
            blurR: adv.blurR ?? preset.blurR,
            blurP: adv.blurP ?? preset.blurP,
          };
        }

        async function removeBackgroundAdv(dataURL, params) {
          const P = Object.assign(
            { inner: 18, outer: 38, ss: 2, blurR: 1, blurP: 2 },
            params || {}
          );
          return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
              const hi = document.createElement("canvas"),
                ctx = hi.getContext("2d", { willReadFrequently: true });
              hi.width = Math.max(1, img.width * P.ss);
              hi.height = Math.max(1, img.height * P.ss);
              ctx.imageSmoothingEnabled = true;
              ctx.drawImage(img, 0, 0, hi.width, hi.height);

              let id = ctx.getImageData(0, 0, hi.width, hi.height);
              let d = id.data,
                W = hi.width,
                H = hi.height;

              function px(x, y) {
                const i = (y * W + x) * 4;
                return [d[i], d[i + 1], d[i + 2]];
              }
              const bg = [
                px(0, 0),
                px(W - 1, 0),
                px(0, H - 1),
                px(W - 1, H - 1),
              ]
                .reduce(
                  (a, c) => [a[0] + c[0], a[1] + c[1], a[2] + c[2]],
                  [0, 0, 0]
                )
                .map((v) => Math.round(v / 4));
              function dist(r, g, b) {
                const dr = r - bg[0],
                  dg = g - bg[1],
                  db = b - bg[2];
                return Math.sqrt(dr * dr + dg * dg + db * db);
              }
              function smoothstep(e0, e1, x) {
                const t = Math.min(1, Math.max(0, (x - e0) / (e1 - e0)));
                return t * t * (3 - 2 * t);
              }

              for (let i = 0; i < d.length; i += 4) {
                const dd = dist(d[i], d[i + 1], d[i + 2]);
                if (dd <= P.inner) d[i + 3] = 0;
                else if (dd < P.outer)
                  d[i + 3] = Math.round(
                    d[i + 3] * smoothstep(P.inner, P.outer, dd)
                  );
              }

              // تمليس قناة الألفا
              if (P.blurR > 0 && P.blurP > 0) {
                const A = new Uint8ClampedArray(W * H);
                const tmp = new Uint8ClampedArray(W * H);
                for (let p = 0; p < P.blurP; p++) {
                  for (let i = 0, j = 3; i < A.length; i++, j += 4) A[i] = d[j];
                  boxBlur1D(A, tmp, W, H, P.blurR, true);
                  boxBlur1D(tmp, A, W, H, P.blurR, false);
                  for (let i = 0, j = 3; i < A.length; i++, j += 4) d[j] = A[i];
                }
              }

              // تنظيف خفيف
              for (let i = 3; i < d.length; i += 4) {
                if (d[i] < 8) d[i] = 0;
                else if (d[i] > 247) d[i] = 255;
              }

              ctx.putImageData(id, 0, 0);

              const out = document.createElement("canvas"),
                octx = out.getContext("2d");
              out.width = Math.max(1, Math.round(W / P.ss));
              out.height = Math.max(1, Math.round(H / P.ss));
              octx.imageSmoothingEnabled = true;
              octx.clearRect(0, 0, out.width, out.height);
              octx.drawImage(hi, 0, 0, out.width, out.height);

              resolve(out.toDataURL("image/png"));
            };
            img.src = dataURL;
          });
        }

        async function maybeRemoveBG(base64, { isFromWord = false } = {}) {
          if (!bgIsEnabled() || !base64 || !base64.startsWith("data:image/"))
            return base64;

          // إذا لم تكن من Word، وكانت الصورة PNG، نفترض أنها معالجة مسبقًا
          if (!isFromWord && base64.startsWith("data:image/png")) {
            return base64;
          }

          return await removeBackgroundAdv(base64, getBgParams());
        }

        function boxBlur1D(src, dst, W, H, r, horizontal) {
          const size = r * 2 + 1;
          if (horizontal) {
            for (let y = 0; y < H; y++) {
              let sum = 0,
                row = y * W;
              for (let x = -r; x <= r; x++) {
                const xi = Math.min(W - 1, Math.max(0, x));
                sum += src[row + xi];
              }
              for (let x = 0; x < W; x++) {
                dst[row + x] = Math.round(sum / size);
                const xAdd = Math.min(W - 1, x + r + 1),
                  xRem = Math.max(0, x - r);
                sum += src[row + xAdd] - src[row + xRem];
              }
            }
          } else {
            for (let x = 0; x < W; x++) {
              let sum = 0;
              for (let y = -r; y <= r; y++) {
                const yi = Math.min(H - 1, Math.max(0, y));
                sum += src[yi * W + x];
              }
              for (let y = 0; y < H; y++) {
                dst[y * W + x] = Math.round(sum / size);
                const yAdd = Math.min(H - 1, y + r + 1),
                  yRem = Math.max(0, y - r);
                sum += src[yAdd * W + x] - src[yRem * W + x];
              }
            }
          }
        }

        /* ========= اكتشاف الإجابة الصحيحة + التعارض ========= */
        const STAR = /[\*★✱∗⭐٭☆]/;
        function clamp(n, lo, hi) {
          return Math.max(lo, Math.min(hi, n));
        }
        function getLookahead() {
          const el = document.getElementById("lookaheadRows");
          const v = parseInt(el?.value, 10);
          return Number.isFinite(v) ? clamp(v, 0, 10) : 3;
        }
        function mapCellToOptionIndex(r, c, coords) {
          for (let i = 0; i < 4; i++) {
            const [tr, tc] = coords.options[i].text || [0, 0];
            const [ir, ic] = coords.options[i].image || [0, 0];
            if ((tr === r && tc === c) || (ir === r && ic === c)) return i;
          }
          let best = -1,
            dist = Infinity;
          for (let i = 0; i < 4; i++) {
            const [tr, tc] = coords.options[i].text || [0, 0];
            const [ir, ic] = coords.options[i].image || [0, 0];
            if (tc === c || ic === c) {
              const d1 = tr ? Math.abs(r - tr) : Infinity;
              const d2 = ir ? Math.abs(r - ir) : Infinity;
              const d = Math.min(d1, d2);
              if (d < dist) {
                dist = d;
                best = i;
              }
            }
          }
          return best;
        }
        function maxOptionRow(coords) {
          let m = 0;
          for (let i = 0; i < 4; i++) {
            m = Math.max(
              m,
              coords.options[i].text?.[0] || 0,
              coords.options[i].image?.[0] || 0
            );
          }
          return m || 0;
        }
        function detectCorrectAnswer(question, rowsSlice, coords) {
          const hits = []; // {idx, where}

          // (أ) نجمة داخل نص الخيار نفسه
          for (let i = 0; i < 4; i++) {
            const t = question.options[i]?.text || "";
            if (STAR.test(t)) {
              hits.push({ idx: i, where: "option-text" });
              question.options[i].text = t.replace(STAR, "").trim();
            }
          }

          // (ب) صفوف لاحقة بعد آخر صف للخيارات (حسب lookahead)
          const LA = getLookahead();
          if (LA > 0 && rowsSlice?.length) {
            const startRow = Math.min(
              rowsSlice.length,
              maxOptionRow(coords) + 1
            );
            const endRow = Math.min(rowsSlice.length, startRow + LA - 1);
            for (let rr = startRow; rr <= endRow; rr++) {
              const rowEl = rowsSlice[rr - 1];
              if (!rowEl) continue;
              const cells = rowEl.querySelectorAll("td,th");
              for (let j = 0; j < cells.length; j++) {
                const raw = (cells[j].textContent || "").trim();
                if (STAR.test(raw)) {
                  const idx = mapCellToOptionIndex(rr, j + 1, coords);
                  if (idx !== -1) {
                    hits.push({ idx, where: "marker-row" });
                    cells[j].textContent = raw.replace(STAR, "").trim();
                  }
                }
              }
            }
          }

          // (ج) مسح احتياطي لكل الشريحة إذا لم نجد شيئًا
          if (!hits.length && rowsSlice?.length) {
            for (let rr = 1; rr <= rowsSlice.length; rr++) {
              const rowEl = rowsSlice[rr - 1];
              const cells = rowEl.querySelectorAll("td,th");
              for (let j = 0; j < cells.length; j++) {
                const raw = (cells[j].textContent || "").trim();
                if (STAR.test(raw)) {
                  const idx = mapCellToOptionIndex(rr, j + 1, coords);
                  if (idx !== -1) {
                    hits.push({ idx, where: "fallback" });
                    cells[j].textContent = raw.replace(STAR, "").trim();
                  }
                }
              }
            }
          }

          const uniq = [...new Set(hits.map((h) => h.idx))];
          if (uniq.length === 1) {
            question.correct = uniq[0];
            delete question._ambiguousCandidates;
          } else if (uniq.length > 1) {
            question.correct = -1;
            question._ambiguousCandidates = uniq;
          } else {
            question.correct = -1;
            delete question._ambiguousCandidates;
          }
        }

        /* ========= استخراج سؤال ========= */
        function extractQuestion(rows, coords, startRow, rowsPerQuestion) {
          if (!rows?.length || startRow >= rows.length) return null;
          const endRow = Math.min(startRow + rowsPerQuestion, rows.length);
          const slice = rows.slice(startRow, endRow);
          if (slice.every(isRowEmpty)) return null;

          const q = {
            reading: cell(slice, coords.readingText),
            question: cell(slice, coords.questionText),
            options: [
              cell(slice, coords.options[0].text),
              cell(slice, coords.options[1].text),
              cell(slice, coords.options[2].text),
              cell(slice, coords.options[3].text),
            ],
            correct: -1,
          };
          q.reading.image = cell(slice, coords.readingImage).image;
          q.question.image = cell(slice, coords.questionImage).image;
          q.options[0].image = cell(slice, coords.options[0].image).image;
          q.options[1].image = cell(slice, coords.options[1].image).image;
          q.options[2].image = cell(slice, coords.options[2].image).image;
          q.options[3].image = cell(slice, coords.options[3].image).image;

          detectCorrectAnswer(q, slice, coords);

          const hasContent =
            q.reading.text ||
            q.reading.image ||
            q.question.text ||
            q.question.image ||
            q.options.some((o) => o.text || o.image);
          return hasContent ? q : null;
        }

        /* ========= عرض المعاينة ========= */
        function renderPreview() {
          const container = document.getElementById("outputArea");
          container.innerHTML = "";
          if (!questions.length) {
            container.innerHTML =
              '<div class="note" style="text-align:center">🚫 لا توجد أسئلة مستخرجة.</div>';
            return;
          }

          questions.forEach((q, index) => {
            const card = document.createElement("div");
            card.className = "question-card";

            const amb = Array.isArray(q._ambiguousCandidates)
              ? q._ambiguousCandidates
              : [];
            const isAmbiguous = amb.length > 1 && q.correct === -1;

            const readingHTML = `
        <div>
          <strong>📘 النص القرائي:</strong>
          <div class="option-box" style="display:flex;flex-direction:column;gap:16px">
            <textarea style="width:100%;min-height:100px;resize:vertical;padding:12px;font-size:16px;"
              onchange="questions[${index}].reading.text=this.value">${
              q.reading?.text || ""
            }</textarea>
            ${
              q.reading?.image
                ? `<img src="${q.reading.image}" class="image-preview" alt="">`
                : ""
            }
            <div class="image-actions">
              <label class="file-input-label">⬆️ رفع/تغيير
                <input type="file" accept="image/*" class="file-input" onchange="uploadImage(event,${index},'reading')">
              </label>
              <button class="btn danger" onclick="questions[${index}].reading.image=null; renderPreview(); stats()">🗑️ حذف</button>
            </div>
          </div>
        </div>`;

            const questionHTML = `
        <div style="margin-top:16px">
          <strong>❓ السؤال:</strong>
          <div class="option-box" style="display:flex;flex-direction:column;gap:16px">
            <textarea style="width:100%;min-height:100px;resize:vertical;padding:12px;font-size:16px;"
              onchange="questions[${index}].question.text=this.value">${
              q.question?.text || ""
            }</textarea>
            ${
              q.question?.image
                ? `<img src="${q.question.image}" class="image-preview" alt="">`
                : ""
            }
            <div class="image-actions">
              <label class="file-input-label">⬆️ رفع/تغيير
                <input type="file" accept="image/*" class="file-input" onchange="uploadImage(event,${index},'question')">
              </label>
              <button class="btn danger" onclick="questions[${index}].question.image=null; renderPreview(); stats()">🗑️ حذف</button>
            </div>
          </div>
        </div>`;

            const optionsHTML = `
        <div style="margin-top:16px">
          <strong>✅ الخيارات:</strong>
          ${
            isAmbiguous
              ? '<div class="ambiguous-note">⚠️ تم العثور على أكثر من نجمة. الخيارات المظللة بالأحمر تحتاج ترجيحك. اختر واحدًا بزر "✔️ تعيين كإجابة صحيحة".</div>'
              : ""
          }
          <div class="options-grid">
            ${q.options
              .map(
                (opt, i) => `
              <div class="option-box
                   ${q.correct === i ? "correct" : ""}
                   ${isAmbiguous && amb.includes(i) ? "ambiguous" : ""}">
                <label>خيار ${i + 1}</label>
                <textarea style="width:100%;min-height:70px;resize:vertical;margin-bottom:12px;padding:10px;font-size:16px;"
                  onchange="questions[${index}].options[${i}].text=this.value">${
                  opt.text || ""
                }</textarea>
                ${
                  opt.image
                    ? `<img src="${opt.image}" class="image-preview" style="margin-bottom:12px" alt="">`
                    : ""
                }
                <div class="image-actions">
                  <label class="file-input-label">⬆️ رفع/تغيير
                    <input type="file" accept="image/*" class="file-input" onchange="uploadImage(event,${index},'option-${i}')">
                  </label>
                  <button class="btn danger" onclick="questions[${index}].options[${i}].image=null; renderPreview(); stats()">🗑️ حذف</button>
                </div>
                <button class="btn" style="margin-top:8px;width:100%" onclick="resolveAmbiguity(${index}, ${i})">✔️ تعيين كإجابة صحيحة</button>
              </div>
            `
              )
              .join("")}
          </div>
        </div>`;

            card.innerHTML = `
        <h3>سؤال ${index + 1}</h3>
        ${readingHTML}
        ${questionHTML}
        ${optionsHTML}
        <button class="btn danger" style="margin-top:16px;width:100%"
          onclick="questions.splice(${index},1); renderPreview(); stats();">🗑️ حذف السؤال</button>
      `;

            document.getElementById("outputArea").appendChild(card);
          });
        }

        function resolveAmbiguity(qIndex, optIndex) {
          const q = questions[qIndex];
          q.correct = optIndex;
          delete q._ambiguousCandidates;
          renderPreview();
          stats();
        }

        /* ========= تصدير/استيراد ========= */
        function exportJSON() {
          if (!questions.length) {
            showAlert("⚠️ لا يوجد محتوى لتصديره", "error");
            return;
          }
          const json = JSON.stringify(questions, null, 2);
          const blob = new Blob([json], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "quiz.json";
          a.click();
          URL.revokeObjectURL(url);
          showAlert("✅ تم تصدير JSON بنجاح", "success");
        }
        function exportCSV() {
          if (!questions.length) {
            showAlert("⚠️ لا يوجد محتوى لتصديره", "error");
            return;
          }
          const rows = [
            [
              "reading_text",
              "reading_image",
              "question_text",
              "question_image",
              "option1_text",
              "option1_image",
              "option2_text",
              "option2_image",
              "option3_text",
              "option3_image",
              "option4_text",
              "option4_image",
              "correct",
            ],
          ];
          questions.forEach((q) => {
            rows.push([
              q.reading.text || "",
              q.reading.image || "",
              q.question.text || "",
              q.question.image || "",
              q.options[0].text || "",
              q.options[0].image || "",
              q.options[1].text || "",
              q.options[1].image || "",
              q.options[2].text || "",
              q.options[2].image || "",
              q.options[3].text || "",
              q.options[3].image || "",
              q.correct + 1 || 0,
            ]);
          });
          const csv = rows
            .map((r) =>
              r.map((v) => `"${String(v).replace(/"/g, '""')}"`).join(",")
            )
            .join("\r\n");
          const blob = new Blob(["\ufeff" + csv], {
            type: "text/csv;charset=utf-8",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "quiz.csv";
          a.click();
          URL.revokeObjectURL(url);
          showAlert("✅ تم تصدير CSV بنجاح", "success");
        }
        function previewJSON() {
          if (!questions.length) {
            showAlert("⚠️ لا يوجد محتوى للمعاينة", "error");
            return;
          }
          const win = window.open("", "_blank");
          win.document.write(
            `<pre style="white-space:pre-wrap">${JSON.stringify(
              questions,
              null,
              2
            )}</pre>`
          );
        }
        function importJSON(e) {
          const file = e?.target?.files?.[0];
          if (!file) return;
          const reader = new FileReader();
          document.getElementById("jsonLoading").style.display = "block";
          reader.onload = async (ev) => {
            try {
              const data = JSON.parse(ev.target.result);
              if (!Array.isArray(data))
                throw new Error("الملف لا يحتوي على مصفوفة أسئلة");

              questions.length = 0;
              questions.push(...data);

              const total = questions.length;
              let done = 0;

              for (const q of questions) {
                if (q.reading?.image)
                  q.reading.image = await maybeRemoveBG(q.reading.image, {
                    isFromWord: false,
                  });
                if (q.question?.image)
                  q.question.image = await maybeRemoveBG(q.question.image, {
                    isFromWord: false,
                  });
                if (q.options?.length) {
                  for (let i = 0; i < q.options.length; i++) {
                    if (q.options[i]?.image)
                      q.options[i].image = await maybeRemoveBG(
                        q.options[i].image,
                        { isFromWord: false }
                      );
                  }
                }
                done++;
                const pct = Math.round((done / Math.max(1, total)) * 100);
                document.getElementById("jsonProgress").style.width = pct + "%";
              }

              renderPreview();
              stats();
              showAlert(`✅ تم تحميل ${questions.length} سؤال`, "success");
            } catch (err) {
              showAlert("❌ خطأ في JSON: " + err.message, "error");
            } finally {
              document.getElementById("jsonLoading").style.display = "none";
              document.getElementById("jsonProgress").style.width = "0%";
            }
          };
          reader.readAsText(file);
        }

        /* ========= معالجة DOCX ========= */
        async function processFile() {
          if (!currentFiles.length) {
            showAlert("🚨 الرجاء اختيار ملف DOCX أولًا", "error");
            return;
          }
          const processButton = document.getElementById("processButton");
          const loading = document.getElementById("loadingIndicator");
          const progressBar = document.getElementById("progressBar");
          const progressFill = document.getElementById("progressFill");
          processButton.disabled = true;
          loading.style.display = "block";
          progressBar.style.display = "block";
          progressFill.style.width = "0%";
          questions.length = 0;

          try {
            const totalFiles = currentFiles.length;
            for (let idx = 0; idx < totalFiles; idx++) {
              const file = currentFiles[idx];
              const startPct = (idx / totalFiles) * 80,
                endPct = ((idx + 1) / totalFiles) * 80;
              const buffer = await file.arrayBuffer();

              const result = await mammoth.convertToHtml(
                { arrayBuffer: buffer },
                {
                  convertImage: mammoth.images.inline(async (el) => {
                    const b64 = await el.read("base64");
                    return { src: `data:${el.contentType};base64,${b64}` };
                  }),
                }
              );
              progressFill.style.width = startPct + 5 + "%";

              const tempDiv = document.createElement("div");
              tempDiv.innerHTML = window.DOMPurify
                ? DOMPurify.sanitize(result.value)
                : result.value;
              const tables = tempDiv.querySelectorAll("table");
              const rowsPerQuestion =
                parseInt(document.getElementById("rowsPerQuestion").value) || 5;

              tables.forEach((table) => {
                const rows = Array.from(table.querySelectorAll("tr"));
                let currentRow = 0;
                while (currentRow < rows.length) {
                  while (
                    currentRow < rows.length &&
                    isRowEmpty(rows[currentRow])
                  )
                    currentRow++;
                  if (currentRow >= rows.length) break;
                  const q = extractQuestion(
                    rows,
                    getCoordinates(),
                    currentRow,
                    rowsPerQuestion
                  );
                  if (q) questions.push(q);
                  currentRow += rowsPerQuestion;
                }
              });
              progressFill.style.width = endPct + "%";
            }

            progressFill.style.width = "85%";
            await Promise.all(
              questions.map(async (q) => {
                if (q.reading.image)
                  q.reading.image = await maybeRemoveBG(q.reading.image, {
                    isFromWord: true,
                  });
                if (q.question.image)
                  q.question.image = await maybeRemoveBG(q.question.image, {
                    isFromWord: true,
                  });
                for (let i = 0; i < q.options.length; i++) {
                  if (q.options[i].image)
                    q.options[i].image = await maybeRemoveBG(
                      q.options[i].image,
                      { isFromWord: true }
                    );
                }
              })
            );
            progressFill.style.width = "100%";

            renderPreview();
            stats();
            showAlert(
              `✅ تم استخراج ${questions.length} سؤال/أسئلة من ${totalFiles} ملف`,
              "success"
            );
          } catch (err) {
            console.error(err);
            showAlert("🚨 خطأ أثناء المعالجة: " + err.message, "error");
          } finally {
            setTimeout(() => {
              loading.style.display = "none";
              progressBar.style.display = "none";
              processButton.disabled = false;
            }, 400);
          }
        }

        /* ========= إحصائيات ========= */
        function stats() {
          document.getElementById("statsBar").style.display = "flex";
          document.getElementById("totalQuestions").textContent =
            questions.length;
          document.getElementById("answeredQuestions").textContent =
            questions.filter((q) => q.correct !== -1).length;
          document.getElementById("questionsWithImages").textContent =
            questions.filter(
              (q) =>
                q.reading.image ||
                q.question.image ||
                q.options.some((o) => o.image)
            ).length;

          const ambiguous = questions.filter(
            (q) =>
              Array.isArray(q._ambiguousCandidates) &&
              q._ambiguousCandidates.length > 1 &&
              q.correct === -1
          ).length;
          const ambEl = document.getElementById("ambiguousQuestions");
          if (ambEl) ambEl.textContent = ambiguous;
        }

        /* ========= إضافات واجهة ========= */
        function clearAll() {
          if (confirm("⚠️ تأكيد مسح جميع الأسئلة؟")) {
            questions.length = 0;
            renderPreview();
            document.getElementById("statsBar").style.display = "none";
            showAlert("تم المسح", "success");
          }
        }
        function resetCoordinates() {
          const set = (n, v) =>
            (document.querySelector(`input[name="${n}"]`).value = v);
          set("r_reading", 1);
          set("c_reading", 1);
          set("r_reading_img", 1);
          set("c_reading_img", 2);
          set("r_question", 2);
          set("c_question", 1);
          set("r_question_img", 2);
          set("c_question_img", 2);
          set("r_opt1", 3);
          set("c_opt1", 1);
          set("r_opt2", 3);
          set("c_opt2", 2);
          set("r_opt3", 4);
          set("c_opt3", 1);
          set("r_opt4", 4);
          set("c_opt4", 2);
          set("r_opt1_img", 3);
          set("c_opt1_img", 3);
          set("r_opt2_img", 3);
          set("c_opt2_img", 4);
          set("r_opt3_img", 4);
          set("c_opt3_img", 3);
          set("r_opt4_img", 4);
          set("c_opt4_img", 4);
          showAlert("تمت إعادة التعيين", "success");
        }
        async function uploadImage(event, qIndex, field) {
          const file = event.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = async () => {
            let base64 = reader.result;
            base64 = await maybeRemoveBG(base64, { isFromWord: true });
            if (field === "reading") questions[qIndex].reading.image = base64;
            else if (field === "question")
              questions[qIndex].question.image = base64;
            else if (field.startsWith("option-")) {
              const i = parseInt(field.split("-")[1], 10);
              questions[qIndex].options[i].image = base64;
            }
            renderPreview();
          };
          reader.readAsDataURL(file);
        }

        /* ========= أحداث DOM ========= */
        document.addEventListener("DOMContentLoaded", () => {
          // حفظ/استرجاع إعدادات الواجهة تلقائيًا
          const ids = [
            "enableBg",
            "bgPreset",
            "bgInner",
            "bgOuter",
            "bgSS",
            "bgBlurR",
            "bgBlurP",
          ];
          ids.forEach((id) => {
            const el = document.getElementById(id);
            if (!el) return;
            const saved = localStorage.getItem("ap_" + id);
            if (saved != null) {
              if (el.type === "checkbox") el.checked = saved === "1";
              else el.value = saved;
            }
          });
          ids.forEach((id) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener("input", () => {
              localStorage.setItem(
                "ap_" + id,
                el.type === "checkbox" ? (el.checked ? "1" : "0") : el.value
              );
            });
          });

          // تحميل DOCX
          const fileInput = document.getElementById("docxFile");
          fileInput.addEventListener("change", function () {
            const info = document.getElementById("fileInfo");
            if (!this.files.length) {
              info.style.display = "none";
              currentFiles = [];
              return;
            }
            currentFiles = Array.from(this.files);
            document.getElementById("fileName").textContent = currentFiles
              .map((f) => f.name)
              .join("، ");
            const size = currentFiles.reduce((s, f) => s + f.size, 0);
            document.getElementById("fileSize").textContent =
              (size / 1024).toFixed(1) + " KB";
            document.getElementById("uploadDate").textContent =
              new Date().toLocaleString();
            info.style.display = "block";
            showAlert(`✅ تم تحميل ${currentFiles.length} ملف`, "success");
          });

          // حفظ/استرجاع lookaheadRows
          const look = document.getElementById("lookaheadRows");
          if (look) {
            const saved = localStorage.getItem("ap_lookaheadRows");
            if (saved) look.value = saved;
            look.addEventListener("input", () =>
              localStorage.setItem("ap_lookaheadRows", look.value)
            );
          }

          // سحب وإفلات
          const dropZone = document.getElementById("dropZone");
          ["dragenter", "dragover", "dragleave", "drop"].forEach((eName) => {
            dropZone.addEventListener(eName, (e) => {
              e.preventDefault();
              e.stopPropagation();
            });
          });
          dropZone.addEventListener("dragover", () => {
            dropZone.style.background = "rgba(26,115,232,0.1)";
          });
          dropZone.addEventListener("dragleave", () => {
            dropZone.style.background = "";
          });
          dropZone.addEventListener("drop", (e) => {
            const files = e.dataTransfer.files;
            if (files.length) {
              document.getElementById("docxFile").files = files;
              document
                .getElementById("docxFile")
                .dispatchEvent(new Event("change"));
            }
            dropZone.style.background = "";
          });

          // Import JSON أعلى
          document
            .getElementById("jsonFile")
            .addEventListener("change", importJSON);
        });

        // Expose functions to the global scope for inline event handlers
        window.uploadImage = uploadImage;
        window.renderPreview = renderPreview;
        window.stats = stats;
        window.resolveAmbiguity = resolveAmbiguity;
        window.processFile = processFile;
        window.exportJSON = exportJSON;
        window.exportCSV = exportCSV;
        window.previewJSON = previewJSON;
        window.clearAll = clearAll;
        window.resetCoordinates = resetCoordinates;
        window.saveCoordinatesPreset = saveCoordinatesPreset;
        window.deleteCoordinatesPreset = deleteCoordinatesPreset;

        document.addEventListener("DOMContentLoaded", populatePresetsDropdown);
        document
          .getElementById("coordPresets")
          .addEventListener("change", loadCoordinatesPreset);
      })();
    </script>
  </body>
</html>
