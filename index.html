<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="utf-8"/>
    <title>ØªØ­ÙˆÙŠÙ„ Ø¬Ø¯Ø§ÙˆÙ„ Word Ø¥Ù„Ù‰ JSON</title>
    <script src="purify.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f0f2f5;
            padding: 20px;
            color: #333;
        }
        h1, h2 {
            color: #1a73e8;
        }
        .btn {
            background: #1a73e8;
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            margin: 8px 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover {
            background: #1557b0;
        }
        .btn.danger {
            background: #dc3545;
        }
        .btn.danger:hover {
            background: #b02a37;
        }
        input[type="file"], input[type="number"] {
            margin: 10px 0;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        input[type="number"] {
            width: 60px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background: #e8f0fe;
            color: #1a73e8;
        }
        .section {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        #outputArea .card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .card textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            min-height: 50px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
        }
        .flex {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        .option-box {
            flex: 1 1 45%;
            border: 1px dashed #ccc;
            padding: 10px;
            border-radius: 6px;
            background: #f8f9fa;
        }
        .option-box.correct {
            border: 2px solid #28a745;
            background: #e6f4ea;
        }
        .option-box img, .card img {
            max-width: 100%;
            max-height: 100px;
            display: block;
            margin-top: 5px;
            border-radius: 4px;
        }
        .config-input {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .config-input label {
            font-weight: bold;
        }
        .note {
            color: #555;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .coords-section {
            margin-bottom: 30px;
        }
        .coords-section h3 {
            color: #1a73e8;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸ“ ØªØ­ÙˆÙŠÙ„ Ø¬Ø¯Ø§ÙˆÙ„ Word Ø¥Ù„Ù‰ JSON</h1>
    <p>ğŸš€ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙƒÙˆÙŠØ² Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆØ³Ø±Ø¹Ø©</p>

    <div class="section">
        <h2>ğŸ“‚ Ø±ÙØ¹ Ù…Ù„Ù Word</h2>
        <input type="file" id="docxFile" accept=".docx">
    </div>

    <div class="section">
        <h2>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„</h2>
        <div class="config-input">
            <label>Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„:</label>
            <input type="number" id="rowsPerQuestion" value="5" min="1">
        </div>

        <div class="coords-section">
            <h3>ğŸ§­ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù†Øµ Ø§Ù„Ù‚Ø±Ø§Ø¦ÙŠ ÙˆØ§Ù„Ø³Ø¤Ø§Ù„</h3>
            <p class="note">â„¹ï¸ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø®Ù„Ø§ÙŠØ§ Ù…Ø®ØªÙ„ÙØ© Ø£Ùˆ Ù†ÙØ³ Ø§Ù„Ø®Ù„ÙŠØ© Ù„Ù„Ù†Øµ ÙˆØµÙˆØ±ØªÙ‡ (Ù…Ø«Ù„ Ù†Øµ ÙˆØµÙˆØ±Ø© ÙÙŠ Ø§Ù„ØµÙ 1ØŒ Ø§Ù„Ø¹Ù…ÙˆØ¯ 1).</p>
            <table>
                <thead>
                    <tr>
                        <th>ğŸ“˜ Ù†Øµ Ù‚Ø±Ø§Ø¦ÙŠ</th>
                        <th>ğŸ–¼ï¸ ØµÙˆØ±Ø© Ø§Ù„Ù†Øµ</th>
                        <th>â“ Ø³Ø¤Ø§Ù„</th>
                        <th>ğŸ–¼ï¸ ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="number" name="r_reading" placeholder="ØµÙ" min="1"><input type="number" name="c_reading" placeholder="Ø¹Ù…ÙˆØ¯" min="1"></td>
                        <td><input type="number" name="r_reading_img" placeholder="ØµÙ" min="1"><input type="number" name="c_reading_img" placeholder="Ø¹Ù…ÙˆØ¯" min="1"></td>
                        <td><input type="number" name="r_question" placeholder="ØµÙ" min="1"><input type="number" name="c_question" placeholder="Ø¹Ù…ÙˆØ¯" min="1"></td>
                        <td><input type="number" name="r_question_img" placeholder="ØµÙ" min="1"><input type="number" name="c_question_img" placeholder="Ø¹Ù…ÙˆØ¯" min="1"></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="coords-section">
            <h3>ğŸŸ¦ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</h3>
            <p class="note">â„¹ï¸ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø®Ù„Ø§ÙŠØ§ Ù…Ø®ØªÙ„ÙØ© Ø£Ùˆ Ù†ÙØ³ Ø§Ù„Ø®Ù„ÙŠØ© Ù„Ù†Øµ Ø§Ù„Ø®ÙŠØ§Ø± ÙˆØµÙˆØ±ØªÙ‡ (Ù…Ø«Ù„ Ù†Øµ ÙˆØµÙˆØ±Ø© ÙÙŠ Ø§Ù„ØµÙ 3ØŒ Ø§Ù„Ø¹Ù…ÙˆØ¯ 1).</p>
            <table>
                <thead>
                    <tr>
                        <th>â‘  Ù†Øµ Ø§Ù„Ø®ÙŠØ§Ø± 1</th>
                        <th>ğŸ–¼ï¸ ØµÙˆØ±Ø© Ø§Ù„Ø®ÙŠØ§Ø± 1</th>
                        <th>â‘¡ Ù†Øµ Ø§Ù„Ø®ÙŠØ§Ø± 2</th>
                        <th>ğŸ–¼ï¸ ØµÙˆØ±Ø© Ø§Ù„Ø®ÙŠØ§Ø± 2</th>
                        <th>â‘¢ Ù†Øµ Ø§Ù„Ø®ÙŠØ§Ø± 3</th>
                        <th>ğŸ–¼ï¸ ØµÙˆØ±Ø© Ø§Ù„Ø®ÙŠØ§Ø± 3</th>
                        <th>â‘£ Ù†Øµ Ø§Ù„Ø®ÙŠØ§Ø± 4</th>
                        <th>ğŸ–¼ï¸ ØµÙˆØ±Ø© Ø§Ù„Ø®ÙŠØ§Ø± 4</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="number" name="r_opt1" placeholder="ØµÙ" min="1"><input type="number" name="c_opt1" placeholder="Ø¹Ù…ÙˆØ¯" min="1"></td>
                        <td><input type="number" name="r_opt1_img" placeholder="ØµÙ" min="1"><input type="number" name="c_opt1_img" placeholder="Ø¹Ù…ÙˆØ¯" min="1"></td>
                        <td><input type="number" name="r_opt2" placeholder="ØµÙ" min="1"><input type="number" name="c_opt2" placeholder="Ø¹Ù…ÙˆØ¯" min="1"></td>
                        <td><input type="number" name="r_opt2_img" placeholder="ØµÙ" min="1"><input type="number" name="c_opt2_img" placeholder="Ø¹Ù…ÙˆØ¯" min="1"></td>
                        <td><input type="number" name="r_opt3" placeholder="ØµÙ" min="1"><input type="number" name="c_opt3" placeholder="Ø¹Ù…ÙˆØ¯" min="1"></td>
                        <td><input type="number" name="r_opt3_img" placeholder="ØµÙ" min="1"><input type="number" name="c_opt3_img" placeholder="Ø¹Ù…ÙˆØ¯" min="1"></td>
                        <td><input type="number" name="r_opt4" placeholder="ØµÙ" min="1"><input type="number" name="c_opt4" placeholder="Ø¹Ù…ÙˆØ¯" min="1"></td>
                        <td><input type="number" name="r_opt4_img" placeholder="ØµÙ" min="1"><input type="number" name="c_opt4_img" placeholder="Ø¹Ù…ÙˆØ¯" min="1"></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <button class="btn danger" onclick="questions.length = 0; renderPreview()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</button>
    </div>

    <div class="section">
        <h2>ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„</h2>
        <button class="btn" onclick="processFile()">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„</button>
    </div>

    <div class="section">
        <h2>ğŸ“‹ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h2>
        <div id="outputArea"></div>
    </div>

    <div style="text-align: center; margin-bottom: 40px;">
        <button class="btn" onclick="exportJSON()">ğŸ’¾ ØªØµØ¯ÙŠØ± JSON</button>
    </div>

    <script src="mammoth.browser.min.js"></script>
    <script>
        const questions = [];

        /**
         * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØµÙ ÙØ§Ø±ØºÙ‹Ø§.
         * @param {HTMLTableRowElement} row - Ø§Ù„ØµÙ.
         * @returns {boolean} true Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØµÙ ÙØ§Ø±ØºÙ‹Ø§.
         */
        function isRowEmpty(row) {
            const cells = row.querySelectorAll('td');
            return Array.from(cells).every(cell => !cell.textContent.trim() && !cell.querySelector('img'));
        }

        /**
         * Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠØ© Ù…Ø¹ Ø§Ù„Ø£Ø®Ø° ÙÙŠ Ø§Ù„Ø§Ø¹ØªØ¨Ø§Ø± colspan.
         * @param {HTMLTableRowElement} row - Ø§Ù„ØµÙ.
         * @returns {number} Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠØ©.
         */
        function getLogicalColumnCount(row) {
            let count = 0;
            const cells = row.querySelectorAll('td');
            cells.forEach(cell => {
                const colspan = parseInt(cell.getAttribute('colspan') || 1);
                count += colspan;
            });
            return count;
        }

        /**
         * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠØ© ÙÙŠ Ø§Ù„ØµÙ.
         * @param {number} r - Ø±Ù‚Ù… Ø§Ù„ØµÙ (ÙŠØ¨Ø¯Ø£ Ù…Ù† 1).
         * @param {number} c - Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ (ÙŠØ¨Ø¯Ø£ Ù…Ù† 1).
         * @param {HTMLTableRowElement[]} rows - ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„.
         * @param {string} field - Ø§Ø³Ù… Ø§Ù„Ø­Ù‚Ù„.
         * @returns {boolean} true Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ØµØ§Ù„Ø­Ø©.
         */
        function validateCoordinates(r, c, rows, field) {
            if (r < 1 || c < 1 || r > rows.length) {
                console.log(`â„¹ï¸ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª "${field}" ØºÙŠØ± ØµØ§Ù„Ø­Ø©: Ø§Ù„ØµÙ (${r}) Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚ (1-${rows.length})`);
                return false;
            }
            const logicalCols = getLogicalColumnCount(rows[r - 1]);
            if (c > logicalCols) {
                console.log(`â„¹ï¸ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª "${field}" ØºÙŠØ± ØµØ§Ù„Ø­Ø©: Ø§Ù„Ø¹Ù…ÙˆØ¯ (${c}) Ø£ÙƒØ¨Ø± Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠØ© (${logicalCols}) ÙÙŠ Ø§Ù„ØµÙ ${r}`);
                return false;
            }
            return true;
        }

        /**
         * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠØ© Ù…Ø¹ Ø¯Ø¹Ù… colspan.
         * @param {HTMLTableRowElement[]} rows - ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„.
         * @param {number} r - Ø±Ù‚Ù… Ø§Ù„ØµÙ (ÙŠØ¨Ø¯Ø£ Ù…Ù† 1).
         * @param {number} c - Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ (ÙŠØ¨Ø¯Ø£ Ù…Ù† 1).
         * @returns {HTMLTableCellElement|null} Ø§Ù„Ø®Ù„ÙŠØ© Ø£Ùˆ null.
         */
        function getCell(rows, r, c) {
            const row = rows[r - 1];
            if (!row) return null;
            const cells = row.querySelectorAll('td');
            let logicalIndex = 0;
            for (let i = 0; i < cells.length; i++) {
                const colspan = parseInt(cells[i].getAttribute('colspan') || 1);
                if (c > logicalIndex && c <= logicalIndex + colspan) {
                    return cells[i];
                }
                logicalIndex += colspan;
            }
            return null;
        }

        /**
         * Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ù† Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„.
         * @param {string} field - Ø§Ø³Ù… Ø§Ù„Ø­Ù‚Ù„ (Ù…Ø«Ù„ r_reading).
         * @returns {number} Ø§Ù„Ù‚ÙŠÙ…Ø© (ØµÙ Ø£Ùˆ Ø¹Ù…ÙˆØ¯).
         */
        function getInputValue(field) {
            return parseInt(document.querySelector(`input[name="${field}"]`)?.value || 0);
        }

        /**
         * Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.
         * @returns {Object} ÙƒØ§Ø¦Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª.
         */
        function getCoordinates() {
            return {
                readingText: [getInputValue('r_reading'), getInputValue('c_reading')],
                readingImage: [getInputValue('r_reading_img'), getInputValue('c_reading_img')],
                questionText: [getInputValue('r_question'), getInputValue('c_question')],
                questionImage: [getInputValue('r_question_img'), getInputValue('c_question_img')],
                options: [
                    {
                        text: [getInputValue('r_opt1'), getInputValue('c_opt1')],
                        image: [getInputValue('r_opt1_img'), getInputValue('c_opt1_img')]
                    },
                    {
                        text: [getInputValue('r_opt2'), getInputValue('c_opt2')],
                        image: [getInputValue('r_opt2_img'), getInputValue('c_opt2_img')]
                    },
                    {
                        text: [getInputValue('r_opt3'), getInputValue('c_opt3')],
                        image: [getInputValue('r_opt3_img'), getInputValue('c_opt3_img')]
                    },
                    {
                        text: [getInputValue('r_opt4'), getInputValue('c_opt4')],
                        image: [getInputValue('r_opt4_img'), getInputValue('c_opt4_img')]
                    }
                ]
            };
        }

        /**
         * Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ø§Ù„Ù†Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø®Ù„ÙŠØ©.
         * @param {HTMLElement} cell - Ø§Ù„Ø®Ù„ÙŠØ©.
         * @returns {string} Ø§Ù„Ù†Øµ Ø§Ù„Ù†Ù‚ÙŠ.
         */
        function extractPureText(cell) {
            const text = cell.textContent ? cell.textContent.trim().replace(/\s+/g, ' ') : '';
            return text || '';
        }

        /**
         * Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ù„ÙŠØ©.
         * @param {HTMLTableRowElement[]} rows - ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„.
         * @param {number[]} coord - [ØµÙ, Ø¹Ù…ÙˆØ¯].
         * @param {number} offset - Ø¥Ø²Ø§Ø­Ø© Ø§Ù„ØµÙ.
         * @param {string} field - Ø§Ø³Ù… Ø§Ù„Ø­Ù‚Ù„.
         * @returns {Object} { text, image }.
         */
        function extractCell(rows, [r, c], offset = 0, field) {
            const cell = getCell(rows, r + offset, c);
            if (!cell) {
                console.log(`â„¹ï¸ Ø§Ù„Ø®Ù„ÙŠØ© (${r + offset}, ${c}) Ù„Ù€ "${field}" ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©`);
                return { text: '', image: null };
            }
            const rawHTML = cell.innerHTML;
            const colspan = cell.getAttribute('colspan') || 1;
            const text = extractPureText(cell);
            const image = cell.querySelector('img')?.src || null;
            console.log(`ğŸ“„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ "${field}" Ù…Ù† (${r + offset}, ${c}): Ù†Øµ="${text}", ØµÙˆØ±Ø©=${image ? 'Ù…ÙˆØ¬ÙˆØ¯Ø©' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'}, colspan=${colspan}, HTML=${rawHTML.substring(0, 200) + (rawHTML.length > 200 ? '...' : '')}`);
            return { text, image };
        }

        /**
         * Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù†Ø¬Ù…Ø©.
         * @param {Object} question - ÙƒØ§Ø¦Ù† Ø§Ù„Ø³Ø¤Ø§Ù„.
         * @param {HTMLTableRowElement[]} rows - ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„.
         * @param {number} startRow - Ø±Ù‚Ù… Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„.
         * @param {number} endRow - Ø±Ù‚Ù… Ø§Ù„ØµÙ Ø§Ù„Ø£Ø®ÙŠØ±.
         */
        function detectCorrectAnswer(question, rows, startRow, endRow) {
            const starPattern = /[\*â˜…âœ±âˆ—]/;
            let correctCount = 0;

            question.options.forEach((opt, index) => {
                if (starPattern.test(opt.text)) {
                    question.correct = index;
                    opt.text = opt.text.replace(starPattern, '').trim();
                    correctCount++;
                }
            });

            if (question.correct === -1) {
                for (let i = startRow; i < endRow && i < rows.length; i++) {
                    const cells = rows[i].querySelectorAll('td');
                    cells.forEach((cell, cellIndex) => {
                        if (starPattern.test(extractPureText(cell))) {
                            question.correct = cellIndex % 4;
                            cell.textContent = cell.textContent.replace(starPattern, '').trim();
                            correctCount++;
                        }
                    });
                }
            }

            if (correctCount > 1) {
                console.warn(`âš ï¸ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙƒØ«Ø± Ù…Ù† Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ÙÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„`);
            }
        }

        /**
         * Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø³Ø¤Ø§Ù„ Ù…Ù† Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„.
         * @param {HTMLTableRowElement[]} rows - ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„.
         * @param {Object} coords - Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.
         * @param {number} startRow - Ø±Ù‚Ù… Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„.
         * @param {number} rowsPerQuestion - Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„.
         * @returns {Object|null} ÙƒØ§Ø¦Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ø£Ùˆ null.
         */
        function extractQuestion(rows, coords, startRow, rowsPerQuestion) {
            if (!rows?.length || startRow >= rows.length) {
                return null;
            }

            const questionRows = rows.slice(startRow, startRow + rowsPerQuestion);
            if (!questionRows.length) {
                return null;
            }

            const maxRows = questionRows.length;
            const maxCols = Math.max(...questionRows.map(row => getLogicalColumnCount(row)));
            console.log(`ğŸ“ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø³Ø¤Ø§Ù„ (Ù…Ù† Ø§Ù„ØµÙ ${startRow + 1}): ${maxRows} ØµÙÙˆÙØŒ Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ ${maxCols} Ø£Ø¹Ù…Ø¯Ø©`);

            const fields = [
                { coord: coords.readingText, name: 'Ù†Øµ Ù‚Ø±Ø§Ø¦ÙŠ' },
                { coord: coords.readingImage, name: 'ØµÙˆØ±Ø© Ø§Ù„Ù†Øµ' },
                { coord: coords.questionText, name: 'Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„' },
                { coord: coords.questionImage, name: 'ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„' },
                ...coords.options.map((opt, i) => [
                    { coord: opt.text, name: `Ù†Øµ Ø§Ù„Ø®ÙŠØ§Ø± ${i + 1}` },
                    { coord: opt.image, name: `ØµÙˆØ±Ø© Ø§Ù„Ø®ÙŠØ§Ø± ${i + 1}` }
                ]).flat()
            ];

            fields.forEach(({ coord, name }) => {
                const [r, c] = coord;
                if (r !== 0 && c !== 0 && !validateCoordinates(r, c, questionRows, name)) {
                    console.log(`â„¹ï¸ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª "${name}" ØºÙŠØ± ØµØ§Ù„Ø­Ø©: (${r}, ${c})`);
                }
            });

            const question = {
                reading: {
                    text: extractCell(rows, coords.readingText, startRow, 'Ù†Øµ Ù‚Ø±Ø§Ø¦ÙŠ').text,
                    image: extractCell(rows, coords.readingImage, startRow, 'ØµÙˆØ±Ø© Ø§Ù„Ù†Øµ').image
                },
                question: {
                    text: extractCell(rows, coords.questionText, startRow, 'Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„').text,
                    image: extractCell(rows, coords.questionImage, startRow, 'ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„').image
                },
                options: coords.options.map((opt, i) => ({
                    text: extractCell(rows, opt.text, startRow, `Ù†Øµ Ø§Ù„Ø®ÙŠØ§Ø± ${i + 1}`).text,
                    image: extractCell(rows, opt.image, startRow, `ØµÙˆØ±Ø© Ø§Ù„Ø®ÙŠØ§Ø± ${i + 1}`).image
                })),
                correct: -1
            };

            detectCorrectAnswer(question, rows, startRow, startRow + rowsPerQuestion);

            return (question.reading.text || question.reading.image ||
                    question.question.text || question.question.image ||
                    question.options.some(opt => opt.text || opt.image)) ? question : null;
        }

        /**
         * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±.
         * @param {Event} event - Ø­Ø¯Ø« Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ù„Ù.
         * @param {number} qIndex - Ø±Ù‚Ù… Ø§Ù„Ø³Ø¤Ø§Ù„.
         * @param {string} field - Ø§Ø³Ù… Ø§Ù„Ø­Ù‚Ù„.
         */
        function uploadImage(event, qIndex, field) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = () => {
                const base64 = reader.result;
                if (field === 'reading' || field === 'question') {
                    questions[qIndex][field].image = base64;
                } else if (field.startsWith('option')) {
                    const optionIndex = parseInt(field.split('-')[1]);
                    questions[qIndex].options[optionIndex].image = base64;
                }
                renderPreview();
            };
            reader.readAsDataURL(file);
        }

        /**
         * Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Word.
         */
        async function processFile() {
            const fileInput = document.getElementById('docxFile');
            const file = fileInput.files[0];
            const rowsPerQuestion = parseInt(document.getElementById('rowsPerQuestion').value) || 5;

            if (!file) {
                alert("ğŸš¨ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Word!");
                return;
            }

            if (!file.name.endsWith('.docx')) {
                alert("ğŸš¨ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨ØµÙŠØºØ© .docx");
                return;
            }

            try {
                const buffer = await file.arrayBuffer();
                const result = await mammoth.convertToHtml({ arrayBuffer: buffer });
                console.log(`ğŸ“œ HTML Ø§Ù„Ù†Ø§ØªØ¬: ${result.value.substring(0, 500) + (result.value.length > 500 ? '...' : '')}`);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = DOMPurify.sanitize(result.value);
                const tables = tempDiv.querySelectorAll('table');
                const coords = getCoordinates();

                questions.length = 0;

                if (!tables.length) {
                    alert("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ø¯Ø§ÙˆÙ„ ÙÙŠ Ø§Ù„Ù…Ù„Ù!");
                    return;
                }

                tables.forEach((table, tableIndex) => {
                    const rows = Array.from(table.querySelectorAll('tr'));
                    let currentRow = 0;

                    while (currentRow < rows.length) {
                        while (currentRow < rows.length && isRowEmpty(rows[currentRow])) {
                            currentRow++;
                        }

                        if (currentRow >= rows.length) break;

                        const question = extractQuestion(rows, coords, currentRow, rowsPerQuestion);
                        if (question) {
                            questions.push(question);
                        }

                        currentRow += rowsPerQuestion;
                    }
                });

                renderPreview();

                if (questions.length === 0) {
                    alert("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£ÙŠ Ø£Ø³Ø¦Ù„Ø©!");
                }
            } catch (err) {
                alert(`ğŸš¨ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù: ${err.message}`);
                console.error(err);
            }
        }

        /**
         * Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©.
         */
        function renderPreview() {
            const container = document.getElementById('outputArea');
            container.innerHTML = '';

            if (!questions.length) {
                container.innerHTML = DOMPurify.sanitize('<p>ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…Ø³ØªØ®Ø±Ø¬Ø©.</p>');
                return;
            }

            questions.forEach((q, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = DOMPurify.sanitize(`
                    <h3>ğŸ§  Ø³Ø¤Ø§Ù„ ${index + 1}</h3>
                    <div><strong>ğŸ“˜ Ø§Ù„Ù†Øµ Ø§Ù„Ù‚Ø±Ø§Ø¦ÙŠ:</strong>
                        <textarea onchange="questions[${index}].reading.text=this.value">${q.reading.text}</textarea>
                        ${q.reading.image ? `<img src="${q.reading.image}">` : ''}
                        <input type="file" accept="image/*" onchange="uploadImage(event, ${index}, 'reading')">
                    </div>
                    <div><strong>â“ Ø§Ù„Ø³Ø¤Ø§Ù„:</strong>
                        <textarea onchange="questions[${index}].question.text=this.value">${q.question.text}</textarea>
                        ${q.question.image ? `<img src="${q.question.image}">` : ''}
                        <input type="file" accept="image/*" onchange="uploadImage(event, ${index}, 'question')">
                    </div>
                    <div><strong>ğŸŸ¦ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª:</strong>
                        <div class="flex">
                            ${q.options.map((opt, i) => `
                                <div class="option-box ${q.correct === i ? 'correct' : ''}">
                                    <label>Ø®ÙŠØ§Ø± ${i + 1}</label><br>
                                    <textarea onchange="questions[${index}].options[${i}].text=this.value">${opt.text}</textarea>
                                    ${opt.image ? `<img src="${opt.image}">` : ''}
                                    <input type="file" accept="image/*" onchange="uploadImage(event, ${index}, 'option-${i}')">
                                    <button class="btn" onclick="questions[${index}].correct=${i}; renderPreview()">âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <button class="btn danger" onclick="questions.splice(${index},1); renderPreview()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„</button>
                `);
                container.appendChild(card);
            });
        }

        /**
         * ØªØµØ¯ÙŠØ± Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙƒÙ€ JSON.
         */
        function exportJSON() {
            if (!questions.length) {
                alert("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„ØªØµØ¯ÙŠØ±Ù‡!");
                return;
            }

            const json = JSON.stringify(questions, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'quiz.json';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
